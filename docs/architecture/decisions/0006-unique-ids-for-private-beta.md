# 1. Unique IDs for private beta

Date: 2024-10-08

Edited: 2024-10-08

## Status

Proposed

## Context

Originally (see [ADR 0004](0004-generating-unique-ids.md)) we looked at randomly generated alpha-numeric reference numbers for the modernised LPAs. The original constraints at the time were:

The reference numbers generated must:

- Only use alpha-numeric characters for readability purposes
- Be unique to allow us to identify 1 LPA application per reference number
- Have a clear prefix to differentiate them from existing IDs and other codes used in our processes.
- Reduce the risk on iteration attacks by making them non-sequential and less guessable (if a threat actor knows LPA 0001 exists trying 0002 gets a result)

Since that time additional business constraints :

- The OPG wants to have a numeric only Reference number to allow for easy entry over the contact centre phone system
- The OPG wants for a purely numeric number to avoid transposition errors over the phone
- OPG asked us to consider if the M- prefix is needed

Reducing the information space around the 12 digit reference number to only the 0-9 characters means we have a maximum of 999,999,999,999 numbers available. Given the smaller information space randomly generated numbers are more difficult here without creating collisions and potentially slowing reference number generation due to retries. So if we adopt these we will have to create a suitable sequence generator.

To reduce transposition errors we can add a check-digit to the number. The Damm algorithm should allow us to pick up common transposition errors at entry point. However this reduces the information space to 99,999,999,999 by removing one character to act as a check digit. Damm detects more errors than the Luhn value used by the older LPA numbers as a check digit.

Without an M- prefix we would need a common numeric identifier for modernised LPAs, which would further reduce the available information space to 9,999,999,999 available options. This could potentially be exhausted in worst case scenarios so we recommend not to do this.

## Decision

We will retain the M- prefix on modernised LPA reference numbers to avoid reducing information space further and keep impact on other services minimal.

LPA reference numbers will be reduced to the numeric components in line with business requirements.

Thus a valid LPA number would be M-0000-0000-0013 where the 3 is a checkdigit generated by the Damm algorithm.

Typical tranposing issues such as digit order twiddling. i.e. 0000-0000-1234 is a correct checkdigit of 4, but 0000-0000-2134 would be invalid detecting the 12 to 21 swap.

We have estimated scenarios for potential ID usage over a 10 year period at current and aggressive growth. (see [spreadsheet attached to issue MLPA-2450](https://opgtransform.atlassian.net/browse/MLPAB-2450)).

## Consequences

- Reducing the information space around the reference number to only the 0-9 characters with a check digit means we have a maximum of 99,999,999,999 numbers available.

- We will generate references non-sequentially, so that it is easier to detect enumeration attacks on any service that uses the ref number as an ID. i.e. 0001 is not followeed by 0002 and our approach should inject sufficient padding to make iteration attacks easily detectable and avoid predictable step jumps.

- LPA reference numbers that are purely numeric are more guessable with enough tries or given sufficient requests. They should not be used as publicly facing identifiers in web based services without some 2nd factor (for example the paper verification codes) and any services using them should put in place detection for brute forcing and iteration based attacks.

- They should not be used in URLs on external-facing systems. None OPG Digital facing services or external-facing APIs (such as the 3rd party supporter API we plan) that need to make direct reference to an LPA a local UUID associated with an LPA should be used instead.

- During private beta it is essential we track LPA reference number usage and adjust our approach accordingly. Particularly if more drafts are created than expected as this could use up the available set of IDs at a greater rate. A checkpoint at the end of private beta to assess this should be put in place.

- The reduced information space will mean we may have to use a different technology in the UID generator due to likelihood of collisions from random generation, potentially a traditional RDS with a sequence generator. This will create rework for teams.

- If ID space looks like it is close to exhausted, OPG has the option to implement a successor prefix i.e. M-0000-0000-0001 to L-0000-0000-0001.

- The prefix is part of the LPA reference number and should asked for and stored in all interactions cases. The reference number should not be stored in a database without the prefix, so should be stored as a string. Dashes are considered part of the string for the performance benefit not constantly re-formatting provides. An LPA reference number is therefore: "M-0000-0000-1234" not "000000001234"

- If a future change to the reference number format is made, then a new prefix should be used to allow systems to determine strategies to interpret it. For example if we change the format to allow letters and remove Damm checkdigits, then a new L- prefix might be used. Prefixes used by other codes in the OPG such as view codes and activitation keys are considered reserved to avoid confusion.

- Modernised LPA reference numbers should be used only for LPAs applications, not sub-actors such as attorneys or non-lpa cases like supervision orders to reduce usage. LPA ids will not be reclaimed if an LPA is cancelled or the donor dies.

- All UIs will have to accomodate any 0 padding in requests for the data. i.e. M-0000-0000-1234 not M-1234
